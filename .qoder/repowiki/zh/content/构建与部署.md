# 构建与部署

<cite>
**本文档引用的文件**
- [pom.xml](file://pom.xml)
- [README.md](file://README.md)
- [SsDriver.java](file://src/main/java/io/leavesfly/smallsql/SsDriver.java)
- [SsConnection.java](file://src/main/java/io/leavesfly/smallsql/jdbc/SsConnection.java)
</cite>

## 目录
1. [简介](#简介)
2. [构建环境要求](#构建环境要求)
3. [Maven构建生命周期](#maven构建生命周期)
4. [标准构建命令](#标准构建命令)
5. [常见构建错误及解决方案](#常见构建错误及解决方案)
6. [JAR文件结构与使用](#jar文件结构与使用)
7. [版本管理策略](#版本管理策略)
8. [部署指南](#部署指南)
9. [依赖管理与分发](#依赖管理与分发)

## 简介

SmallSQL是一个用Java编写的轻量级关系数据库管理系统(RDBMS)，提供了完整的SQL支持和JDBC接口。该项目基于Maven构建系统，通过pom.xml文件定义了项目的依赖关系、构建配置和打包方式。本文档详细说明了从源码到可执行文件的完整构建与部署流程，包括构建环境要求、Maven生命周期、标准构建命令、常见错误解决方案、JAR文件结构、版本管理策略以及在不同Java应用服务器中的部署指南。

**Section sources**
- [README.md](file://README.md#L0-L268)

## 构建环境要求

构建SmallSQL项目需要满足以下环境要求：

- **Java版本**: 1.6或更高版本。根据pom.xml文件中的配置，项目实际使用Java 1.8进行编译。
- **构建工具**: Maven 3.x版本。Maven是Java项目的主要构建工具，负责依赖管理、编译、测试和打包等任务。

项目通过pom.xml文件中的properties部分明确指定了Java版本和编码设置：

```xml
<properties>
    <java.version>1.8</java.version>
    <java.encoding>UTF-8</java.encoding>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
</properties>
```

这些配置确保了项目在不同环境中的一致性构建。构建工具会使用指定的Java版本进行编译，并采用UTF-8编码处理源代码文件，避免了因编码不一致导致的编译问题。

**Section sources**
- [pom.xml](file://pom.xml#L10-L13)
- [README.md](file://README.md#L26-L27)

## Maven构建生命周期

Maven的构建生命周期包含一系列标准化的阶段，SmallSQL项目遵循这些标准阶段进行构建。每个阶段都有特定的目标和任务，确保构建过程的可预测性和一致性。

### clean阶段

clean阶段负责清理项目构建输出目录（通常是target目录），删除之前构建生成的所有文件。这确保了每次构建都是从一个干净的状态开始，避免了旧文件对新构建的干扰。

执行命令：`mvn clean`

### compile阶段

compile阶段负责编译项目的主源代码。Maven会编译src/main/java目录下的所有Java文件，并将编译后的.class文件输出到target/classes目录。此阶段使用pom.xml中配置的Java版本进行编译。

```xml
<plugin>
    <artifactId>maven-compiler-plugin</artifactId>
    <groupId>org.apache.maven.plugins</groupId>
    <configuration>
        <source>${java.version}</source>
        <target>${java.version}</target>
        <encoding>${java.encoding}</encoding>
    </configuration>
</plugin>
```

### test阶段

test阶段负责执行项目的单元测试。Maven会编译src/test/java目录下的测试代码，然后使用测试框架（如JUnit）运行所有测试用例。SmallSQL项目依赖JUnit 4.7进行单元测试。

```xml
<dependency>
    <groupId>junit</groupId>
    <artifactId>junit</artifactId>
    <version>4.7</version>
    <scope>test</scope>
</dependency>
```

### package阶段

package阶段负责将编译后的代码打包成可分发的格式。根据pom.xml中的packaging配置，SmallSQL项目被打包成JAR文件。

```xml
<packaging>jar</packaging>
```

此阶段会将编译后的类文件、资源文件以及必要的元数据打包成一个JAR文件，输出到target目录下。

**Section sources**
- [pom.xml](file://pom.xml#L0-L40)

## 标准构建命令

以下是构建SmallSQL项目的标准命令序列：

```bash
# 清理之前的构建输出
mvn clean

# 编译主源代码
mvn compile

# 执行单元测试
mvn test

# 打包成JAR文件
mvn package

# 一键完成清理、编译、测试和打包
mvn clean package
```

这些命令可以单独执行，也可以组合使用。最常用的是一键构建命令`mvn clean package`，它会依次执行clean、compile、test和package阶段，生成最终的JAR文件。

构建成功后，会在target目录下生成类似`smallsql-1.0.0-SNAPSHOT.jar`的JAR文件，其中版本号来自pom.xml中的配置。

**Section sources**
- [README.md](file://README.md#L234-L241)

## 常见构建错误及解决方案

### Java版本不匹配

**问题**: 构建时出现"Unsupported class file major version"错误。

**原因**: 系统安装的Java版本与pom.xml中指定的版本不匹配。

**解决方案**: 
1. 检查Java版本：`java -version`
2. 确保安装了Java 1.8或更高版本
3. 设置JAVA_HOME环境变量指向正确的Java安装目录

### Maven依赖下载失败

**问题**: 构建时出现"Could not resolve dependencies"错误。

**原因**: 网络问题导致无法从Maven中央仓库下载依赖。

**解决方案**:
1. 检查网络连接
2. 配置Maven镜像仓库（如阿里云镜像）
3. 手动下载依赖并安装到本地仓库

### 编码问题

**问题**: 编译时出现乱码或字符编码错误。

**原因**: 系统默认编码与项目配置的UTF-8编码不一致。

**解决方案**:
1. 确保IDE或编辑器使用UTF-8编码
2. 在Maven命令中显式指定编码：`mvn compile -Dproject.build.sourceEncoding=UTF-8`
3. 检查操作系统区域设置

### 测试失败

**问题**: 单元测试执行失败。

**解决方案**:
1. 查看详细的测试报告（target/surefire-reports）
2. 检查测试环境配置
3. 运行单个测试类进行调试：`mvn test -Dtest=TestClassName`

**Section sources**
- [pom.xml](file://pom.xml#L10-L13)
- [README.md](file://README.md#L234-L241)

## JAR文件结构与使用

### JAR文件结构

构建生成的JAR文件包含以下主要目录和文件：

```
smallsql-1.0.0-SNAPSHOT.jar
├── META-INF/
│   ├── MANIFEST.MF
│   └── maven/
│       └── org.yf/smallsql/
├── io/leavesfly/smallsql/
│   ├── SsDriver.class
│   ├── jdbc/
│   │   ├── SsConnection.class
│   │   ├── SsStatement.class
│   │   └── ...
│   ├── rdb/
│   │   ├── command/
│   │   ├── engine/
│   │   └── ...
│   └── lang/
└── ...
```

### 使用方式

SmallSQL作为JDBC驱动程序使用，可以通过以下步骤集成到Java应用中：

1. **添加依赖**: 将生成的JAR文件添加到项目类路径中
2. **加载驱动**: 使用Class.forName()加载驱动程序
3. **建立连接**: 使用DriverManager.getConnection()建立数据库连接

```java
// 加载SmallSQL驱动
Class.forName("io.leavesfly.smallsql.SsDriver");

// 建立数据库连接
String url = "jdbc:smallsql:./mydb";
Connection conn = DriverManager.getConnection(url);

// 执行SQL操作
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery("SELECT * FROM users");
```

JDBC URL格式为`jdbc:smallsql:[database_path][?property=value...]`，支持通过查询参数配置连接属性，如`autocommit=true`、`locale=en`等。

**Section sources**
- [SsDriver.java](file://src/main/java/io/leavesfly/smallsql/SsDriver.java#L34-L90)
- [SsConnection.java](file://src/main/java/io/leavesfly/smallsql/jdbc/SsConnection.java#L0-L715)

## 版本管理策略

SmallSQL项目采用Maven标准的版本管理策略，通过pom.xml文件中的version元素定义版本号。

```xml
<version>1.0.0-SNAPSHOT</version>
```

### SNAPSHOT版本

- **含义**: SNAPSHOT表示开发中的不稳定版本
- **特点**: 
  - 每次构建都可能包含新的更改
  - Maven会定期检查远程仓库的更新
  - 适合开发和测试环境使用
- **使用场景**: 开发阶段、持续集成、内部测试

### Release版本

- **含义**: Release表示稳定的发布版本
- **特点**:
  - 版本号固定，内容不会改变
  - 适合生产环境使用
  - 通常经过充分测试和验证
- **版本格式**: x.y.z（如1.0.0、1.1.0等）

### 版本升级流程

1. 开发新功能或修复bug
2. 在SNAPSHOT版本上进行测试
3. 稳定后，将版本号从SNAPSHOT改为正式版本号
4. 发布Release版本
5. 将开发分支版本号更新为下一个SNAPSHOT版本

这种版本管理策略确保了开发的灵活性和生产的稳定性。

**Section sources**
- [pom.xml](file://pom.xml#L6-L7)
- [README.md](file://README.md#L2-L5)

## 部署指南

### 嵌入式应用部署

SmallSQL作为轻量级数据库，非常适合嵌入到Java应用中：

1. **添加依赖**: 将smallsql.jar添加到应用的类路径
2. **配置连接**: 设置JDBC URL指向数据目录
3. **初始化**: 在应用启动时加载驱动并建立连接

```java
// 嵌入式部署示例
public class EmbeddedDatabase {
    static {
        try {
            Class.forName("io.leavesfly.smallsql.SsDriver");
        } catch (ClassNotFoundException e) {
            throw new RuntimeException("Failed to load SmallSQL driver", e);
        }
    }
    
    public Connection getConnection() throws SQLException {
        return DriverManager.getConnection("jdbc:smallsql:./data");
    }
}
```

### 应用服务器集成

#### Tomcat部署

1. 将smallsql.jar复制到$CATALINA_HOME/lib目录
2. 在web.xml中配置JNDI数据源
3. 在context.xml中定义Resource

```xml
<Resource name="jdbc/smallsql" 
          auth="Container"
          type="javax.sql.DataSource"
          factory="org.apache.tomcat.jdbc.pool.DataSourceFactory"
          driverClassName="io.leavesfly.smallsql.SsDriver"
          url="jdbc:smallsql:${catalina.home}/data"
          maxActive="20"
          maxIdle="10"
          maxWait="-1"/>
```

#### Spring Boot集成

1. 将smallsql.jar添加为本地依赖
2. 在pom.xml中配置依赖
3. 在application.properties中配置数据源

```properties
spring.datasource.url=jdbc:smallsql:./data
spring.datasource.driver-class-name=io.leavesfly.smallsql.SsDriver
spring.datasource.initialization-mode=never
```

### 数据库文件管理

- **数据目录**: 每个数据库对应一个目录
- **文件组织**: 
  - database.master: 数据库主文件
  - table1.tbl: 表数据文件
  - table1.idx: 索引文件
  - table1.lob: 大对象文件
- **备份策略**: 直接复制整个数据目录进行备份

**Section sources**
- [README.md](file://README.md#L144-L154)
- [SsDriver.java](file://src/main/java/io/leavesfly/smallsql/SsDriver.java#L34-L90)

## 依赖管理与分发

### 依赖管理

SmallSQL项目具有极简的依赖结构，仅依赖JUnit进行测试：

```xml
<dependencies>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.7</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```

这种设计使得SmallSQL成为一个真正的轻量级数据库，无需额外的运行时依赖，可以轻松集成到各种Java应用中。

### 分发方式

#### Maven中央仓库

推荐的分发方式是将SmallSQL发布到Maven中央仓库，这样其他项目可以通过简单的依赖声明使用：

```xml
<dependency>
    <groupId>org.yf</groupId>
    <artifactId>smallsql</artifactId>
    <version>1.0.0</version>
</dependency>
```

#### 直接分发JAR文件

对于内部项目或特殊需求，可以直接分发构建生成的JAR文件：

1. 构建项目：`mvn clean package`
2. 获取JAR文件：target/smallsql-1.0.0-SNAPSHOT.jar
3. 分发给使用者

#### 源码分发

SmallSQL作为开源项目，也可以直接分发源码：

1. 提供完整的源码包
2. 包含pom.xml构建文件
3. 提供详细的构建说明

### 版本兼容性

- **向后兼容**: 新版本尽量保持与旧版本的API兼容
- **数据兼容**: 数据文件格式在版本间保持兼容
- **升级策略**: 提供平滑的升级路径和迁移工具

这种依赖管理和分发策略确保了SmallSQL的易用性和广泛适用性。

**Section sources**
- [pom.xml](file://pom.xml#L34-L40)
- [README.md](file://README.md#L264-L268)