# 连接条件

<cite>
**本文档中引用的文件**  
- [Join.java](file://src/main/java/io/leavesfly/smallsql/rdb/engine/selector/multioper/Join.java)
- [CommandSelect.java](file://src/main/java/io/leavesfly/smallsql/rdb/command/dql/CommandSelect.java)
- [ExpressionArithmetic.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/expression/operator/ExpressionArithmetic.java)
- [SQLParser.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/SQLParser.java)
</cite>

## 目录
1. [连接条件实现机制](#连接条件实现机制)
2. [Join类中condition字段的处理](#join类中condition字段的处理)
3. [ExpressionArithmetic在连接条件中的应用](#expressionarithmetic在连接条件中的应用)
4. [EQUALS操作符的优化处理](#equals操作符的优化处理)
5. [复杂连接条件的编译过程](#复杂连接条件的编译过程)
6. [连接条件表达式构建示例](#连接条件表达式构建示例)
7. [连接条件对性能和执行计划的影响](#连接条件对性能和执行计划的影响)

## 连接条件实现机制

连接条件（ON子句）的实现机制基于`Join`类和`CommandSelect`类的协同工作。当SQL语句包含JOIN操作时，`SQLParser`会解析ON子句并创建相应的`ExpressionArithmetic`对象作为连接条件。该条件被存储在`Join`对象的`condition`字段中，并在查询执行时用于判断连接行的匹配性。

连接操作的执行流程始于`CommandSelect.compile()`方法，该方法会调用`compileJoin()`递归处理所有连接条件。对于每个`Join`对象，系统会根据连接类型（INNER JOIN、LEFT JOIN等）和连接条件来决定如何组合左右两个数据源的行。

**Section sources**
- [CommandSelect.java](file://src/main/java/io/leavesfly/smallsql/rdb/command/dql/CommandSelect.java#L61-L113)
- [SQLParser.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/SQLParser.java#L2226-L2260)

## Join类中condition字段的处理

`Join`类中的`condition`字段是连接条件的核心存储位置，其类型为`Expression`，通常为`ExpressionArithmetic`的实例。该字段在`Join`构造函数中初始化，存储了ON子句中定义的表达式。

```mermaid
classDiagram
class Join {
+Expression condition
+int type
+RowSource left
+RowSource right
+boolean isAfterLast
+LongLongList rowPositions
+int row
+JoinScroll scroll
+Join(int, RowSource, RowSource, Expression)
+boolean isScrollable()
+void beforeFirst()
+boolean next()
+void afterLast()
+int getRow()
+long getRowPosition()
+void setRowPosition(long)
+boolean rowInserted()
+boolean rowDeleted()
+void nullRow()
+void noRow()
+void execute()
+boolean isExpressionsFromThisRowSource(Expressions)
+boolean createJoinScrollIndex()
}
class Expression {
+int type
+String name
+String alias
+Expression[] params
+Expression(int)
+Object clone()
+String getName()
+void setName(String)
+String getAlias()
+void setAlias(String)
+void setParams(Expression[])
+void setParamAt(Expression, int)
+Expression[] getParams()
+void optimize()
+boolean equals(Object)
+boolean isNull()
+boolean getBoolean()
+int getInt()
+long getLong()
+float getFloat()
+double getDouble()
+long getMoney()
+MutableNumeric getNumeric()
+Object getObject()
+String getString()
+byte[] getBytes()
+int getDataType()
+int getType()
}
Join --> Expression : "包含"
```

**Diagram sources**
- [Join.java](file://src/main/java/io/leavesfly/smallsql/rdb/engine/selector/multioper/Join.java#L15-L40)
- [Expression.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/expression/Expression.java#L25-L246)

**Section sources**
- [Join.java](file://src/main/java/io/leavesfly/smallsql/rdb/engine/selector/multioper/Join.java#L15-L40)

## ExpressionArithmetic在连接条件中的应用

`ExpressionArithmetic`类在连接条件中扮演着关键角色，它实现了各种算术和逻辑操作符，包括等值连接（EQUALS）、不等连接（UNEQUALS）以及逻辑与（AND）等。当解析ON子句时，`SQLParser`会创建`ExpressionArithmetic`实例来表示连接条件。

```mermaid
sequenceDiagram
participant SQLParser as "SQLParser"
participant ExpressionArithmetic as "ExpressionArithmetic"
participant Join as "Join"
participant CommandSelect as "CommandSelect"
SQLParser->>ExpressionArithmetic : expression(cmd, 0)
ExpressionArithmetic-->>SQLParser : 返回ExpressionArithmetic实例
SQLParser->>Join : new Join(type, left, right, condition)
Join-->>SQLParser : 返回Join实例
SQLParser->>CommandSelect : 设置from属性
CommandSelect->>CommandSelect : compileJoin(singleJoin)
CommandSelect->>ExpressionArithmetic : compileLinkExpressionParams(condition)
ExpressionArithmetic-->>CommandSelect : 完成表达式链接
```

**Diagram sources**
- [SQLParser.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/SQLParser.java#L2226-L2260)
- [ExpressionArithmetic.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/expression/operator/ExpressionArithmetic.java#L75-L115)
- [CommandSelect.java](file://src/main/java/io/leavesfly/smallsql/rdb/command/dql/CommandSelect.java#L196-L217)

**Section sources**
- [ExpressionArithmetic.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/expression/operator/ExpressionArithmetic.java#L75-L115)

## EQUALS操作符的优化处理

EQUALS操作符在连接条件中得到了特殊优化处理。当连接条件为等值连接时，系统会尝试创建基于索引的连接算法（`JoinScrollIndex`），这可以显著提高连接性能。

```mermaid
flowchart TD
Start([开始连接优化]) --> CheckType["检查连接类型"]
CheckType --> |非INNER_JOIN| ReturnFalse["返回false"]
CheckType --> |INNER_JOIN| CheckCondition["检查条件是否为ExpressionArithmetic"]
CheckCondition --> |否| ReturnFalse
CheckCondition --> |是| ExtractExpressions["提取左右表达式"]
ExtractExpressions --> CheckColumns["验证列是否属于正确的数据源"]
CheckColumns --> |验证失败| ReturnFalse
CheckColumns --> |验证成功| CreateIndex["创建JoinScrollIndex"]
CreateIndex --> SetOperation["设置比较操作为EQUALS"]
SetOperation --> ReturnTrue["返回true，使用索引连接"]
ReturnFalse --> UseDefault["使用默认的循环连接算法"]
```

**Diagram sources**
- [Join.java](file://src/main/java/io/leavesfly/smallsql/rdb/engine/selector/multioper/Join.java#L200-L250)
- [ExpressionArithmetic.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/expression/operator/ExpressionArithmetic.java#L1057-L1083)

**Section sources**
- [Join.java](file://src/main/java/io/leavesfly/smallsql/rdb/engine/selector/multioper/Join.java#L200-L250)

## 复杂连接条件的编译过程

复杂连接条件（如多个AND连接的条件）通过`CommandSelect.compileJoin()`方法的递归调用机制进行编译。该方法会遍历整个连接树，对每个`Join`节点的条件表达式进行链接和优化。

```mermaid
sequenceDiagram
participant CommandSelect as "CommandSelect"
participant Join as "Join"
participant Expression as "Expression"
CommandSelect->>CommandSelect : compileJoin(singleJoin)
CommandSelect->>Expression : compileLinkExpressionParams(condition)
alt 条件存在
Expression->>Expression : 递归处理子表达式
Expression-->>CommandSelect : 完成条件编译
end
alt 左侧为Join
CommandSelect->>CommandSelect : compileJoin(left)
CommandSelect-->>CommandSelect : 递归处理左侧
end
alt 右侧为Join
CommandSelect->>CommandSelect : compileJoin(right)
CommandSelect-->>CommandSelect : 递归处理右侧
end
CommandSelect-->>CommandSelect : 完成整个连接树的编译
```

**Diagram sources**
- [CommandSelect.java](file://src/main/java/io/leavesfly/smallsql/rdb/command/dql/CommandSelect.java#L196-L217)
- [Join.java](file://src/main/java/io/leavesfly/smallsql/rdb/engine/selector/multioper/Join.java#L30-L40)

**Section sources**
- [CommandSelect.java](file://src/main/java/io/leavesfly/smallsql/rdb/command/dql/CommandSelect.java#L196-L217)

## 连接条件表达式构建示例

连接条件表达式的构建涉及简单等值连接和复合条件连接两种主要形式。

### 简单等值连接示例

```sql
SELECT * FROM table1 INNER JOIN table2 ON table1.id = table2.id
```

对应的表达式构建过程：
```mermaid
flowchart LR
A[左表达式: table1.id] --> C[ExpressionArithmetic]
B[右表达式: table2.id] --> C
C --> D[操作符: EQUALS]
C --> E[连接类型: INNER_JOIN]
```

### 复合条件连接示例

```sql
SELECT * FROM table1 INNER JOIN table2 ON table1.id = table2.id AND table1.status = 'active'
```

对应的表达式构建过程：
```mermaid
flowchart TD
A[AND操作] --> B[EQUALS操作1]
A --> C[EQUALS操作2]
B --> D[table1.id]
B --> E[table2.id]
C --> F[table1.status]
C --> G['active']
```

**Section sources**
- [SQLParser.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/SQLParser.java#L1487-L1521)
- [ExpressionArithmetic.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/expression/operator/ExpressionArithmetic.java#L560-L611)

## 连接条件对性能和执行计划的影响

连接条件的结构和内容对查询性能和执行计划有显著影响。等值连接条件可以利用索引进行优化，而非等值连接或复杂条件则可能导致全表扫描。

```mermaid
graph TD
A[连接条件] --> B{是否为等值连接?}
B --> |是| C[尝试使用索引连接]
C --> D{是否存在合适索引?}
D --> |是| E[使用JoinScrollIndex]
D --> |否| F[创建临时索引]
B --> |否| G[使用默认循环连接]
G --> H[性能较低]
E --> I[性能较高]
F --> I
```

等值连接的优化优势在于：
1. 可以利用现有索引或创建临时索引
2. 减少需要比较的行数
3. 提高缓存效率
4. 降低I/O开销

而复杂连接条件（如包含OR、LIKE等操作符）则可能：
1. 无法使用索引优化
2. 需要更多的CPU计算资源
3. 导致更高的内存使用
4. 增加查询响应时间

**Section sources**
- [Join.java](file://src/main/java/io/leavesfly/smallsql/rdb/engine/selector/multioper/Join.java#L200-L250)
- [ExpressionArithmetic.java](file://src/main/java/io/leavesfly/smallsql/rdb/sql/expression/operator/ExpressionArithmetic.java#L560-L611)